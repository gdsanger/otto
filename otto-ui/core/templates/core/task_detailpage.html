{% extends "base.html" %}
{% block content %}
<script>
  window.ottoContext = {
    type: "task",
    name: "{{ task.betreff }}",
    id: "{{ task.id }}",
    gptFunctions: ["get_task_by_id"]
  }
</script>
<div class="container py-4">
  <div class="btn-toolbar mb-3" role="toolbar" aria-label="Toolbar">
    <div class="btn-group me-2" role="group">
      <button id="backBtn" type="button" class="btn btn-outline-secondary">‚Ü©Ô∏è Zur√ºck</button>
      <button id="cloneBtn" type="button" class="btn btn-outline-secondary">üìÑ Clone</button>
    </div>
    <div class="btn-group me-2" role="group">
      <button type="submit" form="taskForm" class="btn btn-primary">üíæ Speichern</button>
      <button id="saveCloseBtn" type="button" class="btn btn-primary">üíæ Speichern &amp; Schlie√üen</button>
    </div>
    <div class="btn-group" role="group">
      <button id="deleteBtn" type="button" class="btn btn-outline-danger">üóëÔ∏è L√∂schen</button>
    </div>
  </div>
  <div class="card mb-3">
    <div class="card-header">
      <h3 class="mb-0">Aufgabe bearbeiten</h3>
    </div>
    <div class="card-body">
      <form id="taskForm">
        {% csrf_token %}
        <input type="hidden" name="task_id" value="{{ task.id }}">
        <div class="mb-3">
          <label class="form-label">TID</label>
          <input class="form-control" type="number" name="tid" value="{{ task.tid }}" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Betreff</label>
          <input class="form-control" type="text" name="betreff" value="{{ task.betreff }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Beschreibung</label>
          <textarea class="form-control" name="beschreibung">{{ task.beschreibung }}</textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Projekt</label>
          <select class="form-select" name="project_id">
            <option value="">-- Kein Projekt --</option>
            {% for projekt in projekte %}
            <option value="{{ projekt.id }}" {% if task.project_id == projekt.id %}selected{% endif %}>{{ projekt.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Meeting</label>
          <select class="form-select" name="meeting_id">
            <option value="">-- Kein Meeting --</option>
            {% for meeting in meetings %}
            <option value="{{ meeting.id }}" {% if task.meeting_id == meeting.id %}selected{% endif %}>{{ meeting.name }}{% if meeting.datum_formatiert %} ({{ meeting.datum_formatiert }}){% endif %}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Zust√§ndig</label>
          <select class="form-select" name="person_id">
            {% for person in personen %}
            <option value="{{ person.id }}" {% if task.person_id == person.id %}selected{% endif %}>{{ person.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Termin</label>
          <input class="form-control" type="date" name="termin" value="{{ task.termin|slice:":10" }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Status</label>
          <select class="form-select" name="status">
            {% for status in status_liste %}
            <option value="{{ status }}" {% if task.status == status %}selected{% endif %}>{{ status }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Priorit√§t</label>
          <select class="form-select" name="prio">
            {% for p in prio_liste %}
            <option value="{{ p }}" {% if task.prio == p %}selected{% endif %}>{{ p }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Typ</label>
          <select class="form-select" name="typ">
            {% for t in typ_liste %}
            <option value="{{ t }}" {% if task.typ == t %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Aufwand (Stunden)</label>
          <input class="form-control" type="number" name="aufwand" value="{{ task.aufwand }}">
        </div>
        <button type="submit" class="btn btn-primary">Speichern</button>
      </form>
    </div>
  </div>
  <div id="saveSuccess" class="alert alert-success d-none">Gespeichert!</div>
</div>
<script>
function getCookie(name){
  let cookieValue = null;
  if(document.cookie && document.cookie !== ''){
    const cookies = document.cookie.split(';');
    for(let i=0;i<cookies.length;i++){
      const cookie = cookies[i].trim();
      if(cookie.substring(0,name.length+1) === (name+'=')){
        cookieValue = decodeURIComponent(cookie.substring(name.length+1));
        break;
      }
    }
  }
  return cookieValue;
}
const form = document.getElementById('taskForm');
const successBox = document.getElementById('saveSuccess');

function saveTask() {
  const data = {};
  new FormData(form).forEach((v, k) => { data[k] = v; });
  return fetch('', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken'),
    },
    body: JSON.stringify(data)
  }).then(r => {
    if (r.ok) {
      successBox.classList.remove('d-none');
      setTimeout(() => successBox.classList.add('d-none'), 2000);
      return true;
    } else {
      alert('Fehler beim Speichern');
      return false;
    }
  });
}

form.addEventListener('submit', function(e){
  e.preventDefault();
  saveTask();
});

document.getElementById('backBtn').addEventListener('click', () => history.back());

document.getElementById('saveCloseBtn').addEventListener('click', () => {
  saveTask().then(ok => { if(ok) history.back(); });
});

document.getElementById('cloneBtn').addEventListener('click', () => {
  const data = {};
  new FormData(form).forEach((v,k)=>{ if(k !== 'task_id') data[k]=v; });
  fetch('/task/new/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken'),
    },
    body: JSON.stringify(data)
  }).then(r => r.ok ? r.json() : Promise.reject()).then(d => {
    if(d.id) {
      window.location.href = `/task/view/${d.id}/`;
    } else {
      alert('Fehler beim Klonen');
    }
  }).catch(() => alert('Fehler beim Klonen'));
});

document.getElementById('deleteBtn').addEventListener('click', () => {
  if(confirm('Wirklich l√∂schen?')) {
    fetch('/task/delete/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: 'task_id=' + encodeURIComponent(form.elements['task_id'].value)
    }).then(r => {
      if(r.ok) {
        history.back();
      } else {
        alert('Fehler beim L√∂schen');
      }
    });
  }
});
</script>
{% endblock %}
