{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <form id="teamForm">
    {% csrf_token %}
    <div class="card">
      <div class="card-header">{{ team.name }}</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Name</label>
          <input type="text" name="name" class="form-control" value="{{ team.name }}">
        </div>
        <h5>Ressourcen</h5>
        <table class="table" id="ressourcenTable">
          <thead>
            <tr>
              <th>Person</th>
              <th>Extern</th>
              <th>Anteil</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for r in team.ressourcen %}
            <tr>
              <td>
                <select name="ressourcen-{{ forloop.counter0 }}-person_id" class="form-select">
                  <option value="">‚Äì w√§hlen ‚Äì</option>
                  {% for p in personen %}
                  <option value="{{ p.id }}" {% if p.id == r.person_id %}selected{% endif %}>{{ p.name }}</option>
                  {% endfor %}
                </select>
              </td>
              <td><input type="checkbox" name="ressourcen-{{ forloop.counter0 }}-extern" class="form-check-input" {% if r.extern %}checked{% endif %}></td>
              <td><input type="number" step="0.1" name="ressourcen-{{ forloop.counter0 }}-anteil" class="form-control" value="{{ r.anteil }}"></td>
              <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">üóëÔ∏è</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <button type="button" class="btn btn-sm btn-outline-primary" id="addRow">Ressource hinzuf√ºgen</button>
      </div>
      <div class="card-footer">
        <button type="submit" class="btn btn-success">Speichern</button>
      </div>
    </div>
    <div id="saveSuccess" class="alert alert-success mt-3 d-none">Gespeichert!</div>
  </form>
</div>
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.getElementById('addRow').addEventListener('click', () => {
    const tbody = document.querySelector('#ressourcenTable tbody');
    const idx = tbody.children.length;
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>
        <select name="ressourcen-${idx}-person_id" class="form-select">
          <option value="">‚Äì w√§hlen ‚Äì</option>
          {% for p in personen %}
          <option value="{{ p.id }}">{{ p.name }}</option>
          {% endfor %}
        </select>
      </td>
      <td><input type="checkbox" name="ressourcen-${idx}-extern" class="form-check-input"></td>
      <td><input type="number" step="0.1" name="ressourcen-${idx}-anteil" class="form-control" value="0"></td>
      <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(row);
  });

  document.querySelector('#ressourcenTable').addEventListener('click', e => {
    if (e.target.classList.contains('remove-row')) {
      e.target.closest('tr').remove();
    }
  });

  const form = document.getElementById('teamForm');
  const successBox = document.getElementById('saveSuccess');
  form.addEventListener('submit', e => {
    e.preventDefault();
    const data = {name: form.elements['name'].value, ressourcen: []};
    const rows = document.querySelectorAll('#ressourcenTable tbody tr');
    rows.forEach((row) => {
      const person = row.querySelector('select').value;
      if (person) {
        data.ressourcen.push({
          person_id: person,
          extern: row.querySelector('input[type=checkbox]').checked,
          anteil: parseFloat(row.querySelector('input[type=number]').value) || 0
        });
      }
    });
    fetch('', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify(data)
    }).then(r => {
      if (r.ok) {
        successBox.classList.remove('d-none');
        setTimeout(() => successBox.classList.add('d-none'), 2000);
      }
    });
  });
</script>
{% endblock %}
