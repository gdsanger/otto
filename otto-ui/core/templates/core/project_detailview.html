{% extends "base.html" %}
{% load static %}
{% load format_tags %}
{% block content %}
<script>
  window.ottoContext = {
    type: "projekt",
    name: "{{ projekt.name }}",
    id: "{{ projekt.id }}",
    gptFunctions: ["get_projekt_by_id"]   
  }
</script>
<div class="container py-4">  
  <form id="projektForm">
    {% csrf_token %}
    <div class="card">
        <div class="card-header">
            {{ projekt.name }}
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-12">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" value="{{ projekt.name }}">
                    </div>
                </div>
                <div class="col-12">
                    <div class="mb-3">
                        <label class="form-label">Short</label>
                        <input type="text" name="short" class="form-control" value="{{ projekt.short }}">
                    </div>
                </div>
                <div class="col-12">
                    <div class="mb-3">
                        <label class="form-label">Beschreibung</label>
                        <textarea name="beschreibung" class="form-control">{{ projekt.beschreibung }}</textarea>
                    </div>
                </div>
                <div class="col-12">
                    <div class="mb-4">
                        <label class="form-label">Stakeholder</label>
                        {% include "components/person_tokenbox.html" with personen=personen selected=projekt.stakeholder_ids %}
                    </div>
                </div>
                <div class="col-6">
                    <div class="mb-4">
                        <label class="form-label">Bearbeiter</label>
                        <select name="bearbeiter" class="form-select">
                            <option value="">‚Äì bitte w√§hlen ‚Äì</option>
                            {% for person in personen %}
                            <option value="{{ person.id }}" {% if person.id == projekt.bearbeiter|default:'' %}selected{% endif %}>
                                {{ person.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>  
                 <div class="col-6">
                     <div class="mb-3">
                        <label class="form-label">Status</label>
                         <select class="form-select" name="status">
                        {% for status1 in status_liste %}
                            <option value="{{ status1 }}" {% if projekt.status == status1 %}selected{% endif %}>{{ status1 }}</option>
                        {% endfor %}
            </select>
                    </div>
                 </div>   
                  <div class="col-6">
                    <div class="mb-3">
                        <label class="form-label">Geplante Fertigstellung</label>
                        <input type="date" name="geplante_fertigstellung" class="form-control" value="{{ projekt.geplante_fertigstellung|default_if_none:'' }}">
                    </div>
                  </div>    
                   <div class="col-6">
                    <div class="mb-3">
                        <label class="form-label">Prio</label>
                         <select class="form-select" name="prio">
                        {% for prio in prio_liste %}
                            <option value="{{ prio }}" {% if projekt.prio == prio %}selected{% endif %}>{{ prio }}</option>
                        {% endfor %}
            </select>
                    </div>
                  </div>                
            </div>
        </div>
        <div class="card-footer">
        <button type="submit" class="btn btn-success">Speichern</button>          
        </div>
    </div>
  <div id="saveSuccess" class="alert alert-success mt-3 d-none">Gespeichert!</div>

   
  </form>

  <hr class="my-4">

  <ul class="nav nav-tabs" id="tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">Tasks</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">Dateien</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#messages" type="button" role="tab">Nachrichten</button>
    </li>
  </ul>
<div class="tab-content mt-3">
     <div class="tab-pane fade show active" id="tasks" role="tabpanel">
  {% if tasks %}
    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>TID</th>
          <th>Betreff</th>
          <th>Status</th>        
          <th>Typ</th>
          <th>Aufwand</th>
          <th>Termin</th>
          <th>Zust√§ndig</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for task in tasks %}
        <tr id="task-{{ task.id }}">
          <td>{{ task.tid }}</td>
          <td><a href="/task/view/{{ task.id }}/">{{ task.betreff }}</a></td>
          <td>
            <select class="form-select form-select-sm auto-save" data-task-id="{{ task.id }}" data-field="status">
              {% for s in status_liste %}
                <option value="{{ s }}" {% if s == task.status %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </td>         
          <td>
            <select class="form-select form-select-sm auto-save" data-task-id="{{ task.id }}" data-field="typ">
              {% for t in typ_liste %}
                <option value="{{ t }}" {% if t == task.typ %}selected{% endif %}>{{ t }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <input type="number" class="form-control form-control-sm auto-save" data-task-id="{{ task.id }}" data-field="aufwand" value="{{ task.aufwand }}">
          </td>
          <td>
            <input type="date" class="form-control form-control-sm auto-save" data-task-id="{{ task.id }}" data-field="termin" value="{{ task.termin|slice:":10" }}">
          </td>
         <td>
  <select class="form-select form-select-sm auto-save" data-task-id="{{ task.id }}" data-field="person_id">
    {% for p in personen %}
      <option value="{{ p.id }}" {% if p.id == task.person_id %}selected{% endif %}>{{ p.name }}</option>
    {% endfor %}
  </select>
</td>
          <td>
            <form hx-post="/task/delete/" hx-confirm="Wirklich l√∂schen?" hx-target="closest tr" hx-swap="outerHTML">
              <input type="hidden" name="task_id" value="{{ task.id }}">
              <button type="submit" class="btn btn-sm btn-outline-danger">üóëÔ∏è</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <h6 class="mt-4">Neue Aufgabe hinzuf√ºgen</h6>
<form id="taskForm" class="row g-2">
  {% csrf_token %}
  <div class="col-12 col-md-4">
    <input type="text" name="betreff" class="form-control" placeholder="Betreff" required>
  </div>
  <div class="col-6 col-md-2">
    <input type="date" name="termin" class="form-control">
  </div>
  <div class="col-6 col-md-2">
    <select name="status" class="form-select">
      {% for s in status_liste %}
      <option value="{{ s }}">{{ s }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12 col-md-3">
    <select name="person_id" class="form-select">
      <option value="">Zust√§ndig w√§hlen</option>
      {% for p in personen %}
      <option value="{{ p.id }}">{{ p.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12 col-md-1">
    <button type="submit" class="btn btn-success w-100">‚ûï</button>
  </div>
</form>

  {% else %}
    <p>Keine Tasks vorhanden.</p>
  {% endif %}
</div>

   <div class="tab-pane fade" id="files" role="tabpanel">
    <input type="file" id="uploadInput" class="form-control mb-3">
    {% if dateien %}
        <ul>
        {% for f in dateien %}
            <li><a href="{{ f.url }}" target="_blank">{{ f.name }} ({{ f.size|filesizeformat }})</a></li>
        {% endfor %}
        </ul>
    {% else %}
        <p>Keine Dateien vorhanden.</p>
   {% endif %}
    </div>
    <div class="tab-pane fade" id="messages" role="tabpanel">
    {% if messages %}
      <table class="table table-sm table-striped">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Betreff</th>
            <th>To</th>
            <th>Richtung</th>
          </tr>
        </thead>
        <tbody>
          {% for mail in messages %}
          <tr>
            <td>{{ mail.datum|slice:':19' }}</td>
            <td><a href="/message/{{ mail.id }}/">{{ mail.subject }}</a></td>
            <td>{{ mail.to|join:', ' }}</td>
            <td>{{ mail.direction }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>Keine Nachrichten vorhanden.</p>
    {% endif %}
    </div>
  </div>
<br/><br/>
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const form = document.getElementById('projektForm');
  const successBox = document.getElementById('saveSuccess');
  const errorBox = document.createElement('div');
  errorBox.className = 'alert alert-danger mt-3 d-none';
  form.appendChild(errorBox);

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(form);
    const jsonData = {};

    formData.forEach((value, key) => {
      if (jsonData[key]) {
        if (!Array.isArray(jsonData[key])) {
          jsonData[key] = [jsonData[key]];
        }
        jsonData[key].push(value);
      } else {
        jsonData[key] = value;
      }
    });

    fetch('', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify(jsonData),
    }).then(r => {
      if (r.ok) {
        successBox.classList.remove('d-none');
        errorBox.classList.add('d-none');
        setTimeout(() => successBox.classList.add('d-none'), 3000);
      } else {
        r.json().then(data => {
          errorBox.textContent = data.error || 'Unbekannter Fehler';
          errorBox.classList.remove('d-none');
        });
      }
    }).catch(err => {
      errorBox.textContent = 'Netzwerkfehler: ' + err.message;
      errorBox.classList.remove('d-none');
    });
  });

 document.querySelectorAll('.auto-save').forEach(el => {
    el.addEventListener('change', e => {
      const taskId = el.dataset.taskId;
      const field = el.dataset.field;
      const value = el.value;

      fetch(`/task/view/${taskId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ [field]: value })
      }).then(r => {
        if (!r.ok) {
          alert('Fehler beim Speichern');
        }
      });
    });
  });

  document.getElementById('taskForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(this));
  data.project_id = window.ottoContext.id;
  data.status = data.status || "Offen";
  data.zust√§ndig = "Otto"; // Optionaler Defaultname

  fetch('/project/createtask/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(data)
  }).then(r => {
    if (r.ok) location.reload();
    else alert('Fehler beim Erstellen der Aufgabe');
  });
});

const fileInput = document.getElementById('uploadInput');
if (fileInput) {
  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (!file) return;
    const fd = new FormData();
    fd.append('file', file);
    fetch('/project/{{ projekt.short }}/upload/', {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: fd
    }).then(r => {
      if (r.ok) location.reload();
      else alert('Fehler beim Upload');
    });
  });
}

document.addEventListener('DOMContentLoaded', () => {
  // Merke zuletzt genutzten Tab in localStorage
  const tabKey = 'projectTab_' + window.ottoContext.id;
  const savedTab = localStorage.getItem(tabKey);
  if (savedTab) {
    const triggerEl = document.querySelector(`#tabs button[data-bs-target="${savedTab}"]`);
    if (triggerEl) {
      bootstrap.Tab.getOrCreateInstance(triggerEl).show();
    }
  }

  document.querySelectorAll('#tabs button[data-bs-toggle="tab"]').forEach(btn => {
    btn.addEventListener('shown.bs.tab', e => {
      const target = e.target.getAttribute('data-bs-target');
      localStorage.setItem(tabKey, target);
    });
  });
});
</script>
{% endblock %}
